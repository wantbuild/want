local want = import "@want";
local wassert = import "./assert.libsonnet";
local linux = import "recipes/linux/linux.libsonnet";
local alpine = import "recipes/alpine/alpine.libsonnet";

local kernel = linux.bzImage;
local alpineRoot = alpine.rootfs(alpine.ARCH_AMD64);

local rootfs = want.pass([
    want.input("", alpineRoot),
    want.input("/initscript", want.blob(|||
        ls -l /
        touch success.txt
        reboot -f
    |||))
]);

local kargs = "console=hvc0 reboot=t panic=-1 rootfstype=virtiofs root=myfs rw init=/bin/sh initscript";

wassert.pathExists(
    want.qemu.amd64_microvm(1, 1e9, kernel,
        initrd=null, kargs=kargs,
        virtiofs={
            "myfs": want.qemu.virtiofs(root=rootfs, writeable=true),
        },
        output=want.qemu.virtiofs_output("myfs", want.prefix(""))
    ),
    "success.txt"
)
